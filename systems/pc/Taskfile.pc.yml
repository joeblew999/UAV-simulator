version: '3'

vars:
  ROOT_DIR: '{{.ROOT_DIR | default "."}}'
  BIN_DIR: '{{.ROOT_DIR}}/.bin'
  EXE_EXT: '{{if eq OS "windows"}}.exe{{end}}'
  PROCESS_COMPOSE_BIN: '{{.BIN_DIR}}/process-compose{{.EXE_EXT}}'

tasks:
  default:
    internal: true
    cmds:
      - task: debug:self

  debug:self:
    desc: Print all vars for debugging
    cmds:
      - echo "=== Process Compose Vars ==="
      - echo "ROOT_DIR={{.ROOT_DIR}}"
      - echo "BIN_DIR={{.BIN_DIR}}"
      - echo "PROCESS_COMPOSE_BIN={{.PROCESS_COMPOSE_BIN}}"
      - echo ""
      - echo "=== Env ==="
      - echo "PC_PORT=$PC_PORT"
    silent: true

  deps:install:
    desc: Install process-compose
    status:
      - test -f {{.PROCESS_COMPOSE_BIN}}
    cmds:
      - mkdir -p {{.BIN_DIR}}
      - sh -c "$(curl --location https://raw.githubusercontent.com/F1bonacc1/process-compose/main/scripts/get-pc.sh)" -- -d -b {{.BIN_DIR}}

  deps:clean:
    desc: Remove process-compose binary
    cmds:
      - rm -f {{.PROCESS_COMPOSE_BIN}}

  up:
    desc: Start NATS + Simulator together (process-compose)
    cmds:
      - '{{.PROCESS_COMPOSE_BIN}} up --port $PC_PORT'

  up:bg:
    desc: Start NATS + Simulator in background
    cmds:
      - '{{.PROCESS_COMPOSE_BIN}} up -d -t=false --port $PC_PORT'

  up:headless:
    desc: Start NATS + Simulator without TUI (for CI/testing)
    cmds:
      - '{{.PROCESS_COMPOSE_BIN}} up -t=false --port $PC_PORT'

  down:
    desc: Stop all process-compose services
    cmds:
      - '{{.PROCESS_COMPOSE_BIN}} down'

  attach:
    desc: Attach to running process-compose TUI
    cmds:
      - '{{.PROCESS_COMPOSE_BIN}} attach'
