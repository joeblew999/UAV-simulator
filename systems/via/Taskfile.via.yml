version: '3'

vars:
  ROOT_DIR: '{{.ROOT_DIR | default "."}}'
  BIN_DIR: '{{.ROOT_DIR}}/.bin'
  SRC_DIR: '{{.ROOT_DIR}}/.src'
  EXE_EXT: '{{if eq OS "windows"}}.exe{{end}}'
  VIA_DIR: '{{.SRC_DIR}}/via'
  VIA_BIN: '{{.BIN_DIR}}/via-dashboard{{.EXE_EXT}}'
  VIA_BIN_NAME: 'via-dashboard{{.EXE_EXT}}'
  VIA_REPO: https://github.com/nicois/via.git

tasks:
  default:
    internal: true
    cmds:
      - task: debug:self

  debug:self:
    desc: Print all vars and env for debugging
    cmds:
      - echo "=== Via Vars ==="
      - echo "ROOT_DIR={{.ROOT_DIR}}"
      - echo "BIN_DIR={{.BIN_DIR}}"
      - echo "SRC_DIR={{.SRC_DIR}}"
      - echo "VIA_DIR={{.VIA_DIR}}"
      - echo "VIA_BIN={{.VIA_BIN}}"
      - echo "VIA_BIN_NAME={{.VIA_BIN_NAME}}"
      - echo ""
      - echo "=== Env ==="
      - echo "VIA_PORT=$VIA_PORT"
      - echo "NATS_URL=$NATS_URL"
      - echo "NATS2SSE_PORT=$NATS2SSE_PORT"
    silent: true

  clone:
    desc: Clone Via repository (for reference/examples)
    status:
      - test -d {{.VIA_DIR}}
    cmds:
      - mkdir -p {{.SRC_DIR}}
      - git clone {{.VIA_REPO}} {{.VIA_DIR}}

  deps:install:
    desc: Build the Via dashboard
    cmds:
      - mkdir -p {{.BIN_DIR}}
      - echo "TODO: Build Via dashboard from systems/via/cmd/"
      # - cd systems/via/cmd && go build -o {{.VIA_BIN}} .

  deps:clean:
    desc: Remove Via source and binary
    cmds:
      - rm -rf {{.VIA_DIR}}
      - rm -f {{.VIA_BIN}}

  start:
    desc: Start Via dashboard server
    cmds:
      - echo "TODO: Start Via dashboard on port $VIA_PORT"
      # - '{{.VIA_BIN}} -addr :$VIA_PORT'

  stop:
    desc: Stop Via dashboard
    cmds:
      - pkill -f {{.VIA_BIN_NAME}} || true
