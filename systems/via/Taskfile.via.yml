version: '3'

env:
  GOWORK: 'off'

vars:
  ROOT_DIR: '{{.ROOT_DIR | default "."}}'
  BIN_DIR: '{{.ROOT_DIR}}/.bin'
  EXE_EXT: '{{if eq OS "windows"}}.exe{{end}}'
  VIA_SRC_DIR: '{{.TASKFILE_DIR}}'
  VIA_BIN: '{{.BIN_DIR}}/via-dashboard{{.EXE_EXT}}'
  VIA_BIN_NAME: 'via-dashboard{{.EXE_EXT}}'

tasks:
  default:
    internal: true
    cmds:
      - task: debug:self

  debug:self:
    desc: Print all vars and env for debugging
    cmds:
      - echo "=== Via Vars ==="
      - echo "ROOT_DIR={{.ROOT_DIR}}"
      - echo "BIN_DIR={{.BIN_DIR}}"
      - echo "VIA_SRC_DIR={{.VIA_SRC_DIR}}"
      - echo "VIA_BIN={{.VIA_BIN}}"
      - echo "VIA_BIN_NAME={{.VIA_BIN_NAME}}"
      - echo ""
      - echo "=== Env ==="
      - echo "VIA_PORT=$VIA_PORT"
      - echo "NATS_URL=$NATS_URL"
      - echo "NATS2SSE_PORT=$NATS2SSE_PORT"
      - echo "NARUN_PORT=$NARUN_PORT"
    silent: true

  deps:install:
    desc: Build the Via dashboard
    status:
      - test -x {{.VIA_BIN}}
    cmds:
      - mkdir -p {{.BIN_DIR}}
      - cd {{.VIA_SRC_DIR}} && go build -o {{.VIA_BIN}} ./cmd/dashboard

  deps:clean:
    desc: Remove Via dashboard binary
    cmds:
      - rm -f {{.VIA_BIN}}

  start:
    desc: Start Via dashboard server
    deps:
      - deps:install
    cmds:
      - '{{.VIA_BIN}} -addr :$VIA_PORT -narun-url http://localhost:$NARUN_PORT -sse-url http://localhost:$NATS2SSE_PORT'

  stop:
    desc: Stop Via dashboard
    cmds:
      - pkill -f {{.VIA_BIN_NAME}} || true
