version: '3'

vars:
  ROOT_DIR: '{{.ROOT_DIR | default "."}}'
  BIN_DIR: '{{.ROOT_DIR}}/.bin'
  DATA_DIR: '{{.ROOT_DIR}}/.data'
  EXE_EXT: '{{if eq OS "windows"}}.exe{{end}}'
  NATS_SERVER_BIN: '{{.BIN_DIR}}/nats-server{{.EXE_EXT}}'
  NATS_SERVER_BIN_NAME: 'nats-server{{.EXE_EXT}}'
  NATS_SERVER_DATA_DIR: '{{.DATA_DIR}}/nats-server'

tasks:
  default:
    internal: true
    cmds:
      - task: debug:self

  debug:self:
    desc: Print all vars and env for debugging
    cmds:
      - echo "=== NATS Server Vars ==="
      - echo "ROOT_DIR={{.ROOT_DIR}}"
      - echo "BIN_DIR={{.BIN_DIR}}"
      - echo "DATA_DIR={{.DATA_DIR}}"
      - echo "NATS_SERVER_BIN={{.NATS_SERVER_BIN}}"
      - echo "NATS_SERVER_BIN_NAME={{.NATS_SERVER_BIN_NAME}}"
      - echo "NATS_SERVER_DATA_DIR={{.NATS_SERVER_DATA_DIR}}"
      - echo ""
      - echo "=== Env ==="
      - echo "NATS_PORT=$NATS_PORT"
      - echo "NATS_URL=$NATS_URL"
    silent: true

  deps:install:
    desc: Install NATS server
    status:
      - test -f {{.NATS_SERVER_BIN}}
    cmds:
      - mkdir -p {{.BIN_DIR}}
      - GOBIN={{.BIN_DIR}} go install github.com/nats-io/nats-server/v2@latest

  deps:clean:
    desc: Remove NATS server binary and data
    cmds:
      - rm -f {{.NATS_SERVER_BIN}}
      - rm -rf {{.NATS_SERVER_DATA_DIR}}

  start:
    desc: Start NATS server
    deps:
      - deps:install
    cmds:
      - mkdir -p {{.NATS_SERVER_DATA_DIR}}
      - '{{.NATS_SERVER_BIN}} -DV -p $NATS_PORT -js -sd {{.NATS_SERVER_DATA_DIR}}'

  stop:
    desc: Stop NATS server
    cmds:
      - pkill -f {{.NATS_SERVER_BIN_NAME}} || true

  status:
    desc: Check NATS server status (requires nats-cli)
    cmds:
      - task nats-cli:rtt
