version: '3'

vars:
  ROOT_DIR: '{{.ROOT_DIR | default "."}}'
  BIN_DIR: '{{.ROOT_DIR}}/.bin'
  SRC_DIR: '{{.ROOT_DIR}}/.src'
  SELFHOSTMAP_DIR: '{{.SRC_DIR}}/selfhostmap'
  SELFHOSTMAP_BIN: '{{.BIN_DIR}}/selfhostmap'
  SELFHOSTMAP_REPO: https://github.com/akhenakh/selfhostmap.git

tasks:
  default:
    internal: true
    cmds:
      - task: debug:self

  debug:self:
    desc: Print all vars and env for debugging
    cmds:
      - echo "=== Selfhostmap Vars ==="
      - echo "ROOT_DIR={{.ROOT_DIR}}"
      - echo "BIN_DIR={{.BIN_DIR}}"
      - echo "SRC_DIR={{.SRC_DIR}}"
      - echo "SELFHOSTMAP_DIR={{.SELFHOSTMAP_DIR}}"
      - echo "SELFHOSTMAP_BIN={{.SELFHOSTMAP_BIN}}"
      - echo ""
      - echo "=== Env ==="
      - echo "SELFHOSTMAP_PORT=$SELFHOSTMAP_PORT"
    silent: true

  clone:
    desc: Clone selfhostmap repository
    status:
      - test -d {{.SELFHOSTMAP_DIR}}
    cmds:
      - mkdir -p {{.SRC_DIR}}
      - git clone {{.SELFHOSTMAP_REPO}} {{.SELFHOSTMAP_DIR}}

  deps:install:
    desc: Clone and build selfhostmap
    deps:
      - clone
    status:
      - test -x {{.SELFHOSTMAP_BIN}}
    cmds:
      - mkdir -p {{.BIN_DIR}}
      - cd {{.SELFHOSTMAP_DIR}} && go build -o {{.SELFHOSTMAP_BIN}} ./cmd/selfhostmap

  deps:clean:
    desc: Remove selfhostmap source and binary
    cmds:
      - rm -rf {{.SELFHOSTMAP_DIR}}
      - rm -f {{.SELFHOSTMAP_BIN}}

  start:
    desc: Start selfhostmap server
    deps:
      - deps:install
    cmds:
      - '{{.SELFHOSTMAP_BIN}} -addr :$SELFHOSTMAP_PORT'

  stop:
    desc: Stop selfhostmap server
    cmds:
      - pkill -f selfhostmap || true
