version: '3'

vars:
  ROOT_DIR: '{{.ROOT_DIR | default "."}}'
  BIN_DIR: '{{.ROOT_DIR}}/.bin'
  DATA_DIR: '{{.ROOT_DIR}}/.data'
  EXE_EXT: '{{if eq OS "windows"}}.exe{{end}}'
  NATS_SERVER: '{{.BIN_DIR}}/nats-server{{.EXE_EXT}}'
  NATS_CLI: '{{.BIN_DIR}}/nats{{.EXE_EXT}}'
  NATS_DATA_DIR: '{{.DATA_DIR}}/nats'

tasks:
  debug:
    desc: Print all vars and env for debugging
    cmds:
      - echo "=== NATS Vars ==="
      - echo "ROOT_DIR={{.ROOT_DIR}}"
      - echo "BIN_DIR={{.BIN_DIR}}"
      - echo "DATA_DIR={{.DATA_DIR}}"
      - echo "NATS_SERVER={{.NATS_SERVER}}"
      - echo "NATS_CLI={{.NATS_CLI}}"
      - echo "NATS_DATA_DIR={{.NATS_DATA_DIR}}"
      - echo ""
      - echo "=== Env ==="
      - echo "NATS_PORT=$NATS_PORT"
      - echo "NATS_URL=$NATS_URL"
    silent: true

  deps:install:
    desc: Install NATS server and CLI
    deps:
      - deps:install:server
      - deps:install:cli

  deps:install:server:
    desc: Install NATS server
    status:
      - test -f {{.NATS_SERVER}}
    cmds:
      - mkdir -p {{.BIN_DIR}}
      - GOBIN={{.BIN_DIR}} go install github.com/nats-io/nats-server/v2@latest

  deps:install:cli:
    desc: Install NATS CLI
    status:
      - test -f {{.NATS_CLI}}
    cmds:
      - mkdir -p {{.BIN_DIR}}
      - GOBIN={{.BIN_DIR}} go install github.com/nats-io/natscli/nats@latest

  deps:clean:
    desc: Remove NATS binaries
    cmds:
      - rm -f {{.NATS_SERVER}} {{.NATS_CLI}}

  start:
    desc: Start NATS server (called by process-compose)
    deps:
      - deps:install:server
    cmds:
      - mkdir -p {{.NATS_DATA_DIR}}
      - '{{.NATS_SERVER}} -DV -p $NATS_PORT -js -sd {{.NATS_DATA_DIR}}'

  stop:
    desc: Stop NATS server
    cmds:
      - pkill -f nats-server || true

  status:
    desc: Check NATS server status
    deps:
      - deps:install:cli
    cmds:
      - '{{.NATS_CLI}} rtt --server $NATS_URL'

  sub:
    desc: Subscribe to all drone telemetry
    deps:
      - deps:install:cli
    cmds:
      - '{{.NATS_CLI}} sub "drone.>"'
