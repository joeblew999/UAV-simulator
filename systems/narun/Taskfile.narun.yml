version: '3'

vars:
  ROOT_DIR: '{{.ROOT_DIR | default "."}}'
  BIN_DIR: '{{.ROOT_DIR}}/.bin'
  SRC_DIR: '{{.ROOT_DIR}}/.src'
  DATA_DIR: '{{.ROOT_DIR}}/.data'
  NARUN_DIR: '{{.SRC_DIR}}/narun'
  NARUN_DATA_DIR: '{{.DATA_DIR}}/narun'
  NARUN_CONFIG_TEMPLATE: '{{.ROOT_DIR}}/systems/narun/config.yaml'
  NARUN_CONFIG: '{{.NARUN_DATA_DIR}}/config.yaml'
  NARUN_CLI_BIN: '{{.BIN_DIR}}/narun'
  NARUN_GW_BIN: '{{.BIN_DIR}}/narun-gw'
  NARUN_REPO: https://github.com/akhenakh/narun.git

tasks:
  debug:
    desc: Print all vars and env for debugging
    cmds:
      - echo "=== Vars ==="
      - echo "ROOT_DIR={{.ROOT_DIR}}"
      - echo "BIN_DIR={{.BIN_DIR}}"
      - echo "SRC_DIR={{.SRC_DIR}}"
      - echo "DATA_DIR={{.DATA_DIR}}"
      - echo "NARUN_DIR={{.NARUN_DIR}}"
      - echo "NARUN_DATA_DIR={{.NARUN_DATA_DIR}}"
      - echo "NARUN_CONFIG_TEMPLATE={{.NARUN_CONFIG_TEMPLATE}}"
      - echo "NARUN_CONFIG={{.NARUN_CONFIG}}"
      - echo "NARUN_CLI_BIN={{.NARUN_CLI_BIN}}"
      - echo "NARUN_GW_BIN={{.NARUN_GW_BIN}}"
      - echo "NARUN_REPO={{.NARUN_REPO}}"
      - echo ""
      - echo "=== Env ==="
      - echo "NATS_URL=$NATS_URL"
      - echo "NARUN_PORT=$NARUN_PORT"
      - echo "NARUN_METRICS_PORT=$NARUN_METRICS_PORT"
      - echo ""
      - 'echo "Note: node-runner only builds on Linux/FreeBSD"'
    silent: true

  clone:
    desc: Clone narun repository
    status:
      - test -d {{.NARUN_DIR}}
    cmds:
      - mkdir -p {{.SRC_DIR}}
      - git clone {{.NARUN_REPO}} {{.NARUN_DIR}}

  pull:
    desc: Pull latest narun changes
    cmds:
      - cd {{.NARUN_DIR}} && git pull

  deps:install:
    desc: Build narun binaries (CLI and gateway)
    deps:
      - clone
    cmds:
      - mkdir -p {{.BIN_DIR}}
      - cd {{.NARUN_DIR}} && go build -o {{.NARUN_CLI_BIN}} ./cmd/narun
      - cd {{.NARUN_DIR}} && go build -o {{.NARUN_GW_BIN}} ./cmd/narun-gw

  deps:clean:
    desc: Remove narun binaries, source, and data
    cmds:
      - rm -f {{.NARUN_CLI_BIN}} {{.NARUN_GW_BIN}}
      - rm -rf {{.NARUN_DIR}}
      - rm -rf {{.NARUN_DATA_DIR}}

  start:
    desc: Start narun gateway (HTTP/gRPC to NATS)
    deps:
      - deps:install
    cmds:
      - mkdir -p {{.NARUN_DATA_DIR}}
      - envsubst < {{.NARUN_CONFIG_TEMPLATE}} > {{.NARUN_CONFIG}}
      - '{{.NARUN_GW_BIN}} -config {{.NARUN_CONFIG}}'

  stop:
    desc: Stop narun gateway
    cmds:
      - pkill -f narun-gw || true
