version: "0.5"

# Load environment variables from .env file
env_file: .env

processes:
  nats-server:
    command: task nats-server:start
    readiness_probe:
      exec:
        command: task nats-cli:rtt
      initial_delay_seconds: 1
      period_seconds: 2

  main:
    command: task main:start
    depends_on:
      nats-server:
        condition: process_healthy
    environment:
      - TERM=xterm-256color
    # No health check - GUI app, runs until closed

  # Optional: telemetry watcher (uncomment to auto-subscribe)
  # telemetry:
  #   command: task nats-cli:sub
  #   depends_on:
  #     nats-server:
  #       condition: process_healthy

  # Voxel-fun 3D visualizer
  voxel:
    command: task voxel:start
    depends_on:
      nats-server:
        condition: process_healthy
    readiness_probe:
      exec:
        command: 'curl -sf http://localhost:$VOXEL_PORT/ || exit 1'
      initial_delay_seconds: 3
      period_seconds: 5

  # Narun HTTP/gRPC gateway to NATS
  narun:
    command: task narun:start
    depends_on:
      nats-server:
        condition: process_healthy
    readiness_probe:
      exec:
        command: 'curl -sf http://localhost:$NARUN_PORT/health || curl -sf http://localhost:$NARUN_METRICS_PORT/metrics || exit 1'
      initial_delay_seconds: 2
      period_seconds: 5

  # NATS to SSE bridge for browser real-time updates
  nats2sse:
    command: task nats2sse:start
    depends_on:
      nats-server:
        condition: process_healthy
    readiness_probe:
      exec:
        command: 'curl -sf http://localhost:$NATS2SSE_PORT/static/index.html || exit 1'
      initial_delay_seconds: 3
      period_seconds: 5

  # Via Datastar dashboard
  via:
    command: task via:start
    depends_on:
      nats-server:
        condition: process_healthy
      nats2sse:
        condition: process_healthy
    readiness_probe:
      exec:
        command: 'curl -sf http://localhost:$VIA_PORT/health || exit 1'
      initial_delay_seconds: 2
      period_seconds: 5
